<!-- form_editar_pedido.html -->
<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editar Pedido</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0/dist/css/select2.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0/dist/js/select2.min.js"></script>
</head>

<body>
  {% include 'partials/navbar.html' %}

  <form class="form" action="{{ url_for('actualizar_pedido') }}" method="post">
    <h2 style="color: #5C0029;">Editar Pedido</h2>
    <hr style="background-color: black; height: 1px; border: none; margin: 1em 0px ;">
    <input type="hidden" name="id" value="{{ pedido['ID'] }}">

    <div class="productos">
      {% if session.get("usuario") %}
      <div class="tag-vendedor">
        <h1>Vendedor: {{ session.get("usuario") }}</h1>
      </div>
      <input type="hidden" name="vendedor" value="{{ session['usuario'] }}">
      {% endif %}

      <h4>Cliente:</h4>
      <input type="text" name="cliente" value="{{ pedido['Cliente'] }}">
      <h4>DNI:</h4>
      <input type="text" name="dni" value="{{ pedido['DNI'] }}">

      <h4>Dirección:</h4>
      <input type="text" name="direccion" value="{{ pedido['Dirección'] }}">

      <h4>Teléfono:</h4>
      <input type="text" name="telefono" value="{{ pedido['Teléfono'] }}">

      <h4>Email:</h4>
      <input type="email" name="email" value="{{ pedido['Email'] }}">

      <h4>Fecha de nacimiento:</h4>
      <input type="date" name="fecha_nacimiento" value="{{ pedido['Fecha de Nacimiento'] }}">

      <h4>Sexo:</h4>
      <select name="sexo_cliente">
        <option value="">--</option>
        {% for s in ["Femenino", "Masculino", "X"] %}
        <option value="{{ s }}" {% if pedido['Sexo']==s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>

      <h4>Fecha de Entrega:</h4>
      <input type="date" name="fecha_entrega" value="{{ pedido['Fecha de Entrega'] }}">

      <h4>Horario de Entrega:</h4>
      <select name="horario_entrega">
        {% for h in ["09:00 a 12:00", "12:00 a 15:00", "15:00 a 18:00", "18:00 a 21:00"] %}
        <option value="{{ h }}" {% if pedido['Horario de Entrega']==h %}selected{% endif %}>{{ h }}</option>
        {% endfor %}
      </select>

      <h4>Tipo de Pedido:</h4>
      <select name="estado">
        {% for e in ["Inmediato", "Entrega a domicilio", "Retiro en local"] %}
        <option value="{{ e }}" {% if pedido['Tipo de Pedido']==e %}selected{% endif %}>{{ e }}</option>
        {% endfor %}
      </select>

      <h4>Método de Pago:</h4>
      <select name="metodo_pago">
        {% for m in ["Efectivo", "Transferencia", "QR", "Débito", "Crédito", "Modo"] %}
        <option value="{{ m }}" {% if pedido['Método de Pago']==m %}selected{% endif %}>{{ m }}</option>
        {% endfor %}
      </select>

      <h4>Banco:</h4>
      <select name="banco">
        {% for b in ["Payway", "Mercado-Pago", "viumi", "-"] %}
        <option value="{{ b }}" {% if pedido['Banco']==b %}selected{% endif %}>{{ b }}</option>
        {% endfor %}
      </select>

      <h4>Descuento:</h4>
      <select name="descuentoOn" id="descuento">
        <option value="0" {% if pedido['Descuento']=='0' %}selected{% endif %}>Sin descuento</option>
        <option value="1" {% if pedido['Descuento']=='1' %}selected{% endif %}>5%</option>
        <option value="2" {% if pedido['Descuento']=='2' %}selected{% endif %}>10%</option>
        <option value="3" {% if pedido['Descuento']=='3' %}selected{% endif %}>15%</option>
      </select>


      <h4>¿Pagado?</h4>
      <select name="pagado">
        <option value="No" {% if pedido['Pagado']=='No' %}selected{% endif %}>No</option>
        <option value="Sí" {% if pedido['Pagado']=='Sí' %}selected{% endif %}>Sí</option>
      </select>

      <h4>Zona de Envío:</h4>
      <select name="zona_envio" id="zona_envio">
        {% for z in ["0", "2500", "3500", "4500", "5500", "6500"] %}
        <option value="{{ z }}" {% if pedido['Costo Envio a Domicilio']==z %}selected{% endif %}>${{ z }}</option>
        {% endfor %}
      </select>

      <h4>Medio (Pidio por):</h4>
      <select name="pidio">
        {% for p in ["Manychat", "Local", "Tienda Nube", "Local Virtual"] %}
        <option value="{{ p }}" {% if pedido['Medio']==p %}selected{% endif %}>{{ p }}</option>
        {% endfor %}
      </select>

      <h4>Local:</h4>
      <select name="local">
        <option value="3 de Febrero" {% if pedido['Local']=='3 de Febrero' %}selected{% endif %}>3 de Febrero</option>
      </select>
    </div>

    <hr style="background-color: black; height: 1px; border: none; margin: 1em 0px ;">

    <div class="submit">
      <h4 style="margin-top: 1em;">Productos</h4>
      <div id="productos-container"></div>
      <button type="button" onclick="agregarProducto()">+ Agregar Producto</button>
      <h4 style="margin-top: 1em;">Observaciones:</h4>
      <input type="text" name="observaciones" value="{{ pedido['Observaciones'] }}">
      <h4>Monto:</h4>
      <input type="number" step="0.01" name="monto" id="monto_total" readonly style="background-color: #eee;">

      <input style="margin-top: 1em;" type="submit" value="Actualizar Pedido">
    </div>
  </form>

  <script>
    const preciosProductos = {{ precios_productos| tojson | safe }};
    const productosConCantidad = {{ pedido['__productos'] | tojson | safe }};
  </script>

  <script>
    function generarItemProducto(nombre = '', cantidad = 1) {
      return `
      <div class="producto-item">
        <div class="producto-linea">
          <label>Producto:</label>
          <select name="productos[]" class="producto-select" required>
            <option value="">Seleccionar producto</option>
            ${Object.keys(preciosProductos).map(id =>
        `<option value="${id}" ${id === nombre ? 'selected' : ''}>
                  ${preciosProductos[id].nombre} - $${preciosProductos[id].precio}
                </option>`
      ).join('')
        }
          </select>
        </div>
        <div class="producto-linea">
          <label>Cantidad:</label>
          <input type="number" name="cantidades[]" min="0.001" step="0.001" value="${cantidad}" required>
        </div>
        <button type="button" class="btn-remove">❌</button>
      </div>`;
    }

    function inicializarSelect2En(elem) {
      // Solo el select recién agregado
      const sel = elem.querySelector('.producto-select');
      if (sel && !sel.classList.contains('select2-initialized')) {
        $(sel).select2({ width: "100%" });
        sel.classList.add('select2-initialized');
      }
    }

    function agregarProducto(nombre = '', cantidad = 1) {
      const container = document.getElementById('productos-container');
      // Agregar sin reconstruir lo existente
      container.insertAdjacentHTML('beforeend', generarItemProducto(nombre, cantidad));
      // Inicializar select2 SOLO en el último agregado
      inicializarSelect2En(container.lastElementChild);
      calcularMonto();
    }

    function calcularMonto() {
      let total = 0;
      document.querySelectorAll('.producto-item').forEach(item => {
        const select = item.querySelector('select[name="productos[]"]');
        const input = item.querySelector('input[name="cantidades[]"]');
        const nombreProducto = select?.value || '';
        const cantidad = parseFloat(input?.value) || 0;
        const precioUnitario = preciosProductos[nombreProducto]?.precio || 0;
        total += precioUnitario * cantidad;
      });

      // Descuento
      const descuentoIndice = parseInt(document.getElementById('descuento').value);
      const porcentajeDescuento = { 0: 0, 1: 5, 2: 10, 3: 15 }[descuentoIndice] || 0;
      const descuentoAplicado = total * (porcentajeDescuento / 100);

      // Envío
      const envio = parseFloat(document.getElementById('zona_envio').value) || 0;

      const totalFinal = total - descuentoAplicado + envio;
      document.getElementById('monto_total').value = totalFinal.toFixed(2);
    }

    // Delegación de eventos para inputs/selects y botón borrar
    document.addEventListener('input', (e) => {
      if (
        e.target.name === 'productos[]' ||
        e.target.name === 'cantidades[]' ||
        e.target.name === 'descuentoOn' ||
        e.target.name === 'zona_envio'
      ) {
        calcularMonto();
      }
    });

    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('btn-remove')) {
        const item = e.target.closest('.producto-item');
        if (item) item.remove();
        calcularMonto();
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      const container = document.getElementById('productos-container');

      // Poblar productos existentes SIN usar lastElementChild directo
      productosConCantidad.forEach(([nombre, cantidad], i) => {
        const html = generarItemProducto(nombre, cantidad);

        // 1) Convertir a fragmento y quedarnos con el .producto-item
        const frag = document.createRange().createContextualFragment(html);
        const item = frag.querySelector('.producto-item');
        if (!item) {
          console.warn('El template no incluye .producto-item; índice:', i);
          return;
        }

        // 2) Adjuntar el item ya resuelto
        container.appendChild(item);

        // 3) Inicializar Select2 (SIEMPRE scopeado al item)
        try {
          inicializarSelect2En(item);  // <— asegurate de que esta funcione en "item", no global
        } catch (e) {
          console.error('Fallo inicializarSelect2En en índice', i, e);
        }
      });

      // Si el template ya tenía algo renderizado de antes:
      container.querySelectorAll('.producto-item').forEach(item => {
        try { inicializarSelect2En(item) } catch (e) { console.error(e) }
      });

      calcularMonto();
    });


    // Asegurar monto antes de enviar
    document.addEventListener('submit', () => {
      calcularMonto();
    });
  </script>


</body>

</html>